parameters:
    # Set to false to disable completely the debug output of executed migration steps in verbose mode
    kaliop_migration_bundle.enable_debug_output: true

    # The directory (inside each bundle, and in src/) where to look for migrations definitions
    # NB: supports per-siteaccess configuration as an override of global configuration. For that, just define parameters:
    #     kaliop_migration_bundle.<siteaccess_group>.version_directory
    kaliop_migration_bundle.version_directory: 'KaliopMigrations'
    # The database tables used to store migration information. Will be created automatically
    # NB: supports per-siteaccess configuration as an override of global configuration. For that, just define parameters:
    #     kaliop_migration_bundle.<siteaccess_group>.table_name
    kaliop_migration_bundle.table_name: 'kaliop_migrations'
    # NB: supports per-siteaccess configuration as an override of global configuration. For that, just define parameters:
    #     kaliop_migration_bundle.<siteaccess_group>.context_table_name
    kaliop_migration_bundle.context_table_name: 'kaliop_migrations_contexts'

    # Used to discriminate valid migration definitions (for SQL migrations)
    kaliop_migration_bundle.valid_databases:
        # names have to correspond to doctrine 'platform', short of version numbers and lowercase
        # NB: this does NOT mean that eZPublish supports all of them :-) By default it supports only mysql and postgresql...
        - 'mysql'
        - 'postgresql'
        - 'oracle'
        - 'sqlite'
        - 'drizzle'
        - 'sqlserver'
        - 'sqlanywhere'

    # Character set used for the migration bundle database tables. Only used by the MySQL Doctrine driver apparently.
    # Due to the Doctrine DB Schema Manager in use, this can not be set to null to mean 'use the default charset of the database').
    # It is a good idea to set it to the same character set used by eZP tables, even though at the moment there are no
    # queries doing joins between migration tables and eZP tables.
    # eZPlatform uses utf8mb4 charset as default
    kaliop_migration_bundle.database_charset: 'utf8mb4'
    kaliop_migration_bundle.database_collation: 'utf8mb4_general_ci'

    # This is by default the max value for a 16-bit integer, which is what SOLR accepts as maximum nuber-of-results
    # limitation for its queries.
    # However, in multi-core configurations, you have to divide this most likely by the number of cores, or you will get
    # an 'java.lang.NegativeArraySizeException' error
    kaliop_migration_bundle.query_limit: 2147483647

    kaliop_migration_bundle.migration_service.class: Kaliop\IbexaMigrationBundle\Core\MigrationService

    kaliop_migration_bundle.loader.filesystem.class: Kaliop\IbexaMigrationBundle\Core\Loader\Filesystem
    kaliop_migration_bundle.loader.filesystem_recursive.class: Kaliop\IbexaMigrationBundle\Core\Loader\FilesystemRecursive

    kaliop_migration_bundle.definition_parser.yaml.class: Kaliop\IbexaMigrationBundle\Core\DefinitionParser\YamlDefinitionParser
    kaliop_migration_bundle.definition_parser.json.class: Kaliop\IbexaMigrationBundle\Core\DefinitionParser\JsonDefinitionParser
    kaliop_migration_bundle.definition_parser.sql.class: Kaliop\IbexaMigrationBundle\Core\DefinitionParser\SQLDefinitionParser
    kaliop_migration_bundle.definition_parser.php.class: Kaliop\IbexaMigrationBundle\Core\DefinitionParser\PHPDefinitionParser

    kaliop_migration_bundle.context_handler.class: Kaliop\IbexaMigrationBundle\Core\ContextHandler

    kaliop_migration_bundle.storage_handler.database.class: Kaliop\IbexaMigrationBundle\Core\StorageHandler\Database\Migration
    kaliop_migration_bundle.context_storage_handler.database.class: Kaliop\IbexaMigrationBundle\Core\StorageHandler\Database\Context

    kaliop_migration_bundle.executor.file.class: Kaliop\IbexaMigrationBundle\Core\Executor\FileExecutor
    kaliop_migration_bundle.executor.http.class: Kaliop\IbexaMigrationBundle\Core\Executor\HTTPExecutor
    kaliop_migration_bundle.executor.loop.class: Kaliop\IbexaMigrationBundle\Core\Executor\LoopExecutor
    kaliop_migration_bundle.executor.migration.class: Kaliop\IbexaMigrationBundle\Core\Executor\MigrationExecutor
    kaliop_migration_bundle.executor.migration_definition.class: Kaliop\IbexaMigrationBundle\Core\Executor\MigrationDefinitionExecutor
    kaliop_migration_bundle.executor.php.class: Kaliop\IbexaMigrationBundle\Core\Executor\PHPExecutor
    kaliop_migration_bundle.executor.process.class: Kaliop\IbexaMigrationBundle\Core\Executor\ProcessExecutor
    kaliop_migration_bundle.executor.service.class: Kaliop\IbexaMigrationBundle\Core\Executor\ServiceExecutor
    kaliop_migration_bundle.executor.sql.class: Kaliop\IbexaMigrationBundle\Core\Executor\SQLExecutor
    kaliop_migration_bundle.executor.reference.class: Kaliop\IbexaMigrationBundle\Core\Executor\ReferenceExecutor
    kaliop_migration_bundle.executor.repository.class: Kaliop\IbexaMigrationBundle\Core\Executor\RepositoryExecutor

    kaliop_migration_bundle.executor.content_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ContentManager
    kaliop_migration_bundle.executor.content_version_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ContentVersionManager
    kaliop_migration_bundle.executor.content_type_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ContentTypeManager
    kaliop_migration_bundle.executor.content_type_group_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ContentTypeGroupManager
    kaliop_migration_bundle.executor.language_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\LanguageManager
    kaliop_migration_bundle.executor.location_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\LocationManager
    kaliop_migration_bundle.executor.object_state_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ObjectStateManager
    kaliop_migration_bundle.executor.object_state_group_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\ObjectStateGroupManager
    kaliop_migration_bundle.executor.role_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\RoleManager
    kaliop_migration_bundle.executor.section_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\SectionManager
    kaliop_migration_bundle.executor.tag_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\TagManager
    kaliop_migration_bundle.executor.trash_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\TrashManager
    kaliop_migration_bundle.executor.user_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\UserManager
    kaliop_migration_bundle.executor.url_alias.class: Kaliop\IbexaMigrationBundle\Core\Executor\UrlAliasManager
    kaliop_migration_bundle.executor.url_wildcard.class: Kaliop\IbexaMigrationBundle\Core\Executor\UrlWildcardManager
    kaliop_migration_bundle.executor.user_group_manager.class: Kaliop\IbexaMigrationBundle\Core\Executor\UserGroupManager

    kaliop_migration_bundle.content_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ContentMatcherDirectLoad
    kaliop_migration_bundle.content_type_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ContentTypeMatcher
    kaliop_migration_bundle.content_type_group_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ContentTypeGroupMatcher
    kaliop_migration_bundle.content_version_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ContentVersionMatcher
    kaliop_migration_bundle.language_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\LanguageMatcher
    kaliop_migration_bundle.location_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\LocationMatcherDirectLoad
    kaliop_migration_bundle.object_state_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ObjectStateMatcher
    kaliop_migration_bundle.object_state_group_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ObjectStateGroupMatcher
    kaliop_migration_bundle.reference_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\ReferenceMatcher
    kaliop_migration_bundle.role_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\RoleMatcher
    kaliop_migration_bundle.section_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\SectionMatcher
    kaliop_migration_bundle.tag_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\TagMatcher
    kaliop_migration_bundle.trash_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\TrashMatcher
    kaliop_migration_bundle.url_alias_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\UrlAliasMatcher
    kaliop_migration_bundle.url_wildcard_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\UrlWildcardMatcher
    kaliop_migration_bundle.user_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\UserMatcher
    kaliop_migration_bundle.user_group_matcher.class: Kaliop\IbexaMigrationBundle\Core\Matcher\UserGroupMatcher

    kaliop_migration_bundle.complex_field_manager.class: Kaliop\IbexaMigrationBundle\Core\FieldHandlerManager
    kaliop_migration_bundle.complex_field.ibexa_author.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaAuthor
    kaliop_migration_bundle.complex_field.ibexa_binaryfile.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaBinaryFile
    kaliop_migration_bundle.complex_field.ibexa_boolean.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaBoolean
    kaliop_migration_bundle.complex_field.country.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaCountry
    kaliop_migration_bundle.complex_field.ibexa_date.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaDate
    kaliop_migration_bundle.complex_field.ibexa_datetime.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaDateAndTime
    kaliop_migration_bundle.complex_field.ibexa_image.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaImage
    kaliop_migration_bundle.complex_field.ibexa_matrix.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaMatrix
    kaliop_migration_bundle.complex_field.ibexa_media.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaMedia
    #kaliop_migration_bundle.complex_field.ezpage.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\EzPage
    kaliop_migration_bundle.complex_field.ezrelation.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaRelation
    kaliop_migration_bundle.complex_field.ezrelationlist.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaRelationList
    kaliop_migration_bundle.complex_field.ibexa_richtext.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaRichText
    kaliop_migration_bundle.complex_field.ibexa_selection.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaSelection
    kaliop_migration_bundle.complex_field.ibexa_image_asset.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaImageAsset
    kaliop_migration_bundle.complex_field.ezxmltext.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaXmlText
    kaliop_migration_bundle.complex_field.eztags.class: Kaliop\IbexaMigrationBundle\Core\FieldHandler\IbexaTags

    kaliop_migration_bundle.reference_resolver.chain.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\ChainResolver
    kaliop_migration_bundle.reference_resolver.chain_prefix.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\ChainPrefixResolver
    kaliop_migration_bundle.reference_resolver.customreference.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\CustomReferenceResolver
    kaliop_migration_bundle.reference_resolver.content.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\ContentResolver
    kaliop_migration_bundle.reference_resolver.expression.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\ExpressionResolver
    kaliop_migration_bundle.reference_resolver.location.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\LocationResolver
    kaliop_migration_bundle.reference_resolver.loop.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\LoopResolver
    kaliop_migration_bundle.reference_resolver.tag.class: Kaliop\IbexaMigrationBundle\Core\ReferenceResolver\TagResolver

    kaliop_migration_bundle.helper.limitation_converter.class: Kaliop\IbexaMigrationBundle\Core\Helper\LimitationConverter
    kaliop_migration_bundle.helper.sort_converter.class: Kaliop\IbexaMigrationBundle\Core\Helper\SortConverter
    kaliop_migration_bundle.helper.console_io.class: Kaliop\IbexaMigrationBundle\Core\Helper\ConsoleIO
    kaliop_migration_bundle.helper.config.resolver: Kaliop\IbexaMigrationBundle\Core\Helper\ConfigResolver

    kaliop_migration_bundle.step_executed_listener.tracing.class: Kaliop\IbexaMigrationBundle\Core\EventListener\TracingStepExecutedListener

services:

    kaliop_migration_bundle.migration_service:
        public: true
        class: '%kaliop_migration_bundle.migration_service.class%'
        arguments:
            - '@kaliop_migration_bundle.loader'
            - '@kaliop_migration_bundle.storage_handler'
            - '@ibexa.api.repository'
            - '@event_dispatcher'
            - '@kaliop_migration_bundle.context_handler'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        tags:
            - { name: kaliop_migration_bundle.context_provider, label: migration_service }
        calls:
            - ['setPermissionResolver', ['@Ibexa\Contracts\Core\Repository\PermissionResolver']]
            - ['setUserService', ['@Ibexa\Contracts\Core\Repository\UserService']]
            # @todo review - is this the best way to get a handle on this ?
            - ['setConnection', ['@ibexa.api.storage_engine.legacy.connection']]

    ### loaders

    kaliop_migration_bundle.loader:
        alias: kaliop_migration_bundle.loader.filesystem

    kaliop_migration_bundle.loader.filesystem:
        class: '%kaliop_migration_bundle.loader.filesystem.class%'
        arguments:
            - '@kernel'
            - 'kaliop_migration_bundle.version_directory'
            - '@kaliop_migration_bundle.helper.config.resolver'

    kaliop_migration_bundle.loader.filesystem_recursive:
        class: '%kaliop_migration_bundle.loader.filesystem_recursive.class%'
        arguments:
            - '@kernel'
            - 'kaliop_migration_bundle.version_directory'
            - '@kaliop_migration_bundle.helper.config.resolver'

    ### parsers

    kaliop_migration_bundle.definition_parser.yaml:
        class: '%kaliop_migration_bundle.definition_parser.yaml.class%'
        arguments: []
        tags:
            - { name: kaliop_migration_bundle.definition_parser }

    kaliop_migration_bundle.definition_parser.json:
        class: '%kaliop_migration_bundle.definition_parser.json.class%'
        arguments: []
        tags:
            - { name: kaliop_migration_bundle.definition_parser }

    kaliop_migration_bundle.definition_parser.sql:
        class: '%kaliop_migration_bundle.definition_parser.sql.class%'
        arguments:
            - '%kaliop_migration_bundle.valid_databases%'
        tags:
            - { name: kaliop_migration_bundle.definition_parser }

    kaliop_migration_bundle.definition_parser.php:
        class: '%kaliop_migration_bundle.definition_parser.php.class%'
        arguments: []
        tags:
            - { name: kaliop_migration_bundle.definition_parser }

    ### storage handlers

    kaliop_migration_bundle.storage_handler:
        alias: kaliop_migration_bundle.storage_handler.database

    kaliop_migration_bundle.storage_handler.database:
        class: '%kaliop_migration_bundle.storage_handler.database.class%'
        arguments:
            - '@ibexa.api.storage_engine.legacy.connection'
            - 'kaliop_migration_bundle.table_name'
            - '@kaliop_migration_bundle.helper.config.resolver'
            - { charset: '%kaliop_migration_bundle.database_charset%', collate: '%kaliop_migration_bundle.database_collation%'}

    kaliop_migration_bundle.context_storage_handler:
        alias: kaliop_migration_bundle.context_storage_handler.database

    kaliop_migration_bundle.context_storage_handler.database:
        class: '%kaliop_migration_bundle.context_storage_handler.database.class%'
        arguments:
            - '@ibexa.api.storage_engine.legacy.connection'
            - 'kaliop_migration_bundle.context_table_name'
            - '@kaliop_migration_bundle.helper.config.resolver'
            - { charset: '%kaliop_migration_bundle.database_charset%', collate: '%kaliop_migration_bundle.database_collation%' }

    ### executors

    kaliop_migration_bundle.executor.file:
        class: '%kaliop_migration_bundle.executor.file.class%'
        arguments:
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.http:
        class: '%kaliop_migration_bundle.executor.http.class%'
        arguments:
            - '@service_container'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.loop:
        class: '%kaliop_migration_bundle.executor.loop.class%'
        arguments:
            - '@kaliop_migration_bundle.migration_service'
            - '@kaliop_migration_bundle.reference_resolver.loop'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }
        # avoid 'ServiceCircularReferenceException' errors by making this lazy
        lazy: true

    kaliop_migration_bundle.executor.migration:
        class: '%kaliop_migration_bundle.executor.migration.class%'
        arguments:
            - '@kaliop_migration_bundle.reference_matcher'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
            - '@kaliop_migration_bundle.executor.content_manager'
            - '@kaliop_migration_bundle.executor.location_manager'
            - '@kaliop_migration_bundle.executor.content_type_manager'
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.migration_definition:
        class: '%kaliop_migration_bundle.executor.migration_definition.class%'
        arguments:
            - '@kaliop_migration_bundle.migration_service'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        # avoid 'ServiceCircularReferenceException' errors when this service is injected into a migration service
        # that is related to the event dispatcher by making it lazy
        lazy: true
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.php:
        class: '%kaliop_migration_bundle.executor.php.class%'
        arguments:
            - '@service_container'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.process:
        class: '%kaliop_migration_bundle.executor.process.class%'
        arguments:
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.reference:
        class: '%kaliop_migration_bundle.executor.reference.class%'
        arguments:
            - '@service_container'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.service:
        class: '%kaliop_migration_bundle.executor.service.class%'
        arguments:
            - '@service_container'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.sql:
        class: '%kaliop_migration_bundle.executor.sql.class%'
        arguments:
            - '@ibexa.api.storage_engine.legacy.connection'
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.repository:
        abstract: true
        class: '%kaliop_migration_bundle.executor.repository.class%'
        calls:
            - ['setRepository', ['@ibexa.api.repository']]
            - ['setReferenceResolver', ['@kaliop_migration_bundle.reference_resolver.customreference']]
            - ['setConfigResolver', ['@ibexa.config.resolver']]
            # SF bug? this method is not called for child srevices as it belongs to a trait instead of teh base class...
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
            - ['setPermissionResolver', ['@Ibexa\Contracts\Core\Repository\PermissionResolver']]
            - ['setUserService', ['@Ibexa\Contracts\Core\Repository\UserService']]

    kaliop_migration_bundle.executor.content_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.content_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.user_matcher'
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.object_state_group_matcher'
            - '@kaliop_migration_bundle.complex_field_manager'
            - '@kaliop_migration_bundle.executor.location_manager'
            - '@kaliop_migration_bundle.helper.sort_converter'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.content_version_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.content_version_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.user_matcher'
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.object_state_group_matcher'
            - '@kaliop_migration_bundle.complex_field_manager'
            - '@kaliop_migration_bundle.executor.location_manager'
            - '@kaliop_migration_bundle.helper.sort_converter'
            - '@kaliop_migration_bundle.content_version_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.content_type_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.content_type_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.content_type_matcher'
            - '@kaliop_migration_bundle.content_type_group_matcher'
            - '@kaliop_migration_bundle.reference_resolver'
            - '@kaliop_migration_bundle.complex_field_manager'
            - '@kaliop_migration_bundle.helper.sort_converter'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.content_type_group_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.content_type_group_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.content_type_group_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.language_manager:
        class: '%kaliop_migration_bundle.executor.language_manager.class%'
        parent: kaliop_migration_bundle.executor.repository
        arguments:
            - '@kaliop_migration_bundle.language_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.location_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.location_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
            - '@kaliop_migration_bundle.location_matcher'
            - '@kaliop_migration_bundle.helper.sort_converter'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.object_state_manager:
        class: '%kaliop_migration_bundle.executor.object_state_manager.class%'
        parent: kaliop_migration_bundle.executor.repository
        arguments:
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.object_state_group_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.object_state_group_manager:
        class: '%kaliop_migration_bundle.executor.object_state_group_manager.class%'
        parent: kaliop_migration_bundle.executor.repository
        arguments:
            - '@kaliop_migration_bundle.object_state_group_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.role_manager:
        class: '%kaliop_migration_bundle.executor.role_manager.class%'
        parent: kaliop_migration_bundle.executor.repository
        arguments:
            - '@kaliop_migration_bundle.role_matcher'
            - '@kaliop_migration_bundle.helper.limitation_converter'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.section_manager:
        class: '%kaliop_migration_bundle.executor.section_manager.class%'
        parent: kaliop_migration_bundle.executor.repository
        arguments:
            - '@kaliop_migration_bundle.section_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.tag_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.tag_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.tag_matcher'
            - '@?eztags.api.service.tags'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.trash_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.trash_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.trash_matcher'
            - '@kaliop_migration_bundle.helper.sort_converter'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.user_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.user_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.user_matcher'
            - '@kaliop_migration_bundle.user_group_matcher'
            - '@kaliop_migration_bundle.role_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.url_alias:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.url_alias.class%'
        arguments:
            - '@kaliop_migration_bundle.url_alias_matcher'
            - '@kaliop_migration_bundle.executor.location_manager'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.url_wildcard:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.url_wildcard.class%'
        arguments:
            - '@kaliop_migration_bundle.url_wildcard_matcher'
        calls:
            - [ 'setReferenceMatcher', [ '@kaliop_migration_bundle.reference_matcher' ] ]
        tags:
            - { name: kaliop_migration_bundle.executor }

    kaliop_migration_bundle.executor.user_group_manager:
        parent: kaliop_migration_bundle.executor.repository
        class: '%kaliop_migration_bundle.executor.user_group_manager.class%'
        arguments:
            - '@kaliop_migration_bundle.user_group_matcher'
            - '@kaliop_migration_bundle.role_matcher'
            - '@kaliop_migration_bundle.section_matcher'
        calls:
            - ['setReferenceMatcher', ['@kaliop_migration_bundle.reference_matcher']]
        tags:
            - { name: kaliop_migration_bundle.executor }

    ### matchers

    kaliop_migration_bundle.content_matcher:
        class: '%kaliop_migration_bundle.content_matcher.class%'
        arguments:
            - '@ibexa.api.repository'
            - '@kaliop_migration_bundle.user_group_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.user_matcher'
            - '%kaliop_migration_bundle.query_limit%'
            - '@Ibexa\Core\QueryType\ArrayQueryTypeRegistry'

    kaliop_migration_bundle.content_type_matcher:
        class: '%kaliop_migration_bundle.content_type_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.content_type_group_matcher:
        class: '%kaliop_migration_bundle.content_type_group_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.content_version_matcher:
        class: '%kaliop_migration_bundle.content_version_matcher.class%'
        arguments:
            - '@ibexa.api.repository'
            - '@kaliop_migration_bundle.content_matcher'

    kaliop_migration_bundle.language_matcher:
        class: '%kaliop_migration_bundle.language_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.location_matcher:
        class: '%kaliop_migration_bundle.location_matcher.class%'
        arguments:
            - '@ibexa.api.repository'
            - '@kaliop_migration_bundle.user_group_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.user_matcher'
            - '%kaliop_migration_bundle.query_limit%'
            - '@Ibexa\Core\QueryType\ArrayQueryTypeRegistry'

    kaliop_migration_bundle.object_state_matcher:
        class: '%kaliop_migration_bundle.object_state_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.object_state_group_matcher:
        class: '%kaliop_migration_bundle.object_state_group_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.reference_matcher:
        class: '%kaliop_migration_bundle.reference_matcher.class%'
        arguments:
            - '@kaliop_migration_bundle.reference_resolver.customreference'
            - '@validator'

    kaliop_migration_bundle.role_matcher:
        class: '%kaliop_migration_bundle.role_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.section_matcher:
        class: '%kaliop_migration_bundle.section_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.tag_matcher:
        class: '%kaliop_migration_bundle.tag_matcher.class%'
        arguments:
            - '@Ibexa\Contracts\Core\SiteAccess\ConfigResolverInterface'
            - '@?eztags.api.service.tags'

    kaliop_migration_bundle.trash_matcher:
        class: '%kaliop_migration_bundle.trash_matcher.class%'
        arguments:
            - '@ibexa.api.repository'
            - '@kaliop_migration_bundle.user_group_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.object_state_matcher'
            - '@kaliop_migration_bundle.user_matcher'
            - '%kaliop_migration_bundle.query_limit%'

    kaliop_migration_bundle.url_alias_matcher:
        class: '%kaliop_migration_bundle.url_alias_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.url_wildcard_matcher:
        class: '%kaliop_migration_bundle.url_wildcard_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.user_matcher:
        class: '%kaliop_migration_bundle.user_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    kaliop_migration_bundle.user_group_matcher:
        class: '%kaliop_migration_bundle.user_group_matcher.class%'
        arguments:
            - '@ibexa.api.repository'

    ### field handlers

    kaliop_migration_bundle.complex_field_manager:
        class: '%kaliop_migration_bundle.complex_field_manager.class%'
        arguments:
             - '@ibexa.api.service.field_type'

    kaliop_migration_bundle.complex_field:
        abstract: true
        calls:
            - ['setReferenceResolver', ['@kaliop_migration_bundle.reference_resolver.customreference']]

    # NB: you can register handlers for either a field type, using the  'fieldtype' attribute, or for the
    #     field type of a specific content type by using both 'fieldtype' and 'contenttype' in the tag definition

    kaliop_migration_bundle.complex_field.ibexa_author:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_author.class%'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_author, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_binaryfile:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_binaryfile.class%'
        arguments:
            - "$io.root_dir$"
            - "@?ibexa.core.io.default_url_decorator"
            - "@?ibexa.field_type.ibexa_binaryfile.io_service"
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_binaryfile, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_boolean:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_boolean.class%'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_boolean, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_country:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.country.class%'
        arguments:
            - '@ibexa.api.service.content_type'
            - '@ibexa.api.service.field_type'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_country, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_date:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_date.class%'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_date, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_datetime:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_datetime.class%'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_datetime, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_image:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_image.class%'
        arguments:
            - "$io.root_dir$"
            - "@?ibexa.core.io.default_url_decorator"
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_image, priority: 0 }


    kaliop_migration_bundle.complex_field.ibexa_matrix:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_matrix.class%'
        #arguments:
        #    - "$io.root_dir$"
        #    - "@?ibexa.core.io.default_url_decorator"
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_matrix, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_media:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_media.class%'
        arguments:
            - "$io.root_dir$"
            - "@?ibexa.core.io.default_url_decorator"
            - "@?ibexa.field_type.ibexa_binaryfile.io_service"
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_media, priority: 0 }

    #kaliop_migration_bundle.complex_field.ezpage:
    #    lazy: true
    #    parent: kaliop_migration_bundle.complex_field
    #    class: '%kaliop_migration_bundle.complex_field.ezpage.class%'
    #    arguments:
    #        - '@ibexa.fieldType.ezpage.pageService'
    #    tags:
    #        - { name: kaliop_migration_bundle.complex_field, fieldtype: ezpage, priority: 0 }

    kaliop_migration_bundle.complex_field.ezrelation:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ezrelation.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_object_relation, priority: 0 }

    kaliop_migration_bundle.complex_field.ezrelationlist:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ezrelationlist.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_object_relation_list, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_richtext:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_richtext.class%'
        arguments:
            # if you want to replace custom references in rich text fields, you can replace this with a new service
            # built f.e. using the ChainPrefixResolver class
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_richtext, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_selection:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_selection.class%'
        arguments:
            - '@ibexa.api.repository'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_selection, priority: 0 }

    kaliop_migration_bundle.complex_field.ezxmltext:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ezxmltext.class%'
        arguments:
            # if you want to replace custom references in rich text fields, you can replace this with a new service
            # built f.e. using the ChainPrefixResolver class
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ezxmltext, priority: 0 }

    kaliop_migration_bundle.complex_field.eztags:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.eztags.class%'
        arguments:
            - '@kaliop_migration_bundle.tag_matcher'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: eztags, priority: 0 }

    kaliop_migration_bundle.complex_field.ibexa_image_asset:
        parent: kaliop_migration_bundle.complex_field
        class: '%kaliop_migration_bundle.complex_field.ibexa_image_asset.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'
        tags:
            - { name: kaliop_migration_bundle.complex_field, fieldtype: ibexa_image_asset, priority: 0 }

    ### reference resolvers

    # A service that will resolve *any* possible reference. To be used with care
    # At the moment is is only used to resolve references in definitions of FieldType settings, and even then, only
    # for backwards compatibility
    kaliop_migration_bundle.reference_resolver:
        alias: kaliop_migration_bundle.reference_resolver.chain

    kaliop_migration_bundle.reference_resolver.chain:
        class: '%kaliop_migration_bundle.reference_resolver.chain.class%'
        arguments:
            -
                - '@kaliop_migration_bundle.reference_resolver.customreference'
                # Neither location nor content resolving are enabled by default any more
                #- '@kaliop_migration_bundle.reference_resolver.location'
                #- '@kaliop_migration_bundle.reference_resolver.content'
                - '@kaliop_migration_bundle.reference_resolver.tag'

    kaliop_migration_bundle.reference_resolver.content:
        class: '%kaliop_migration_bundle.reference_resolver.content.class%'
        arguments:
            - '@kaliop_migration_bundle.content_matcher'

    kaliop_migration_bundle.reference_resolver.expression:
        class: '%kaliop_migration_bundle.reference_resolver.expression.class%'
        arguments:
            - '@kaliop_migration_bundle.reference_resolver.customreference'
        lazy: true

    kaliop_migration_bundle.reference_resolver.location:
        class: '%kaliop_migration_bundle.reference_resolver.location.class%'
        arguments:
            - '@kaliop_migration_bundle.location_matcher'

    kaliop_migration_bundle.reference_resolver.loop:
        class: '%kaliop_migration_bundle.reference_resolver.loop.class%'

    kaliop_migration_bundle.reference_resolver.tag:
        class: '%kaliop_migration_bundle.reference_resolver.tag.class%'
        arguments:
            - '@kaliop_migration_bundle.tag_matcher'

    # A service which resolves *only* custom references (plus loop variables and expressions). As such, it is used in most places
    kaliop_migration_bundle.reference_resolver.customreference:
        alias: kaliop_migration_bundle.reference_resolver.customreference.flexible

    kaliop_migration_bundle.reference_resolver.customreference.base:
        class: '%kaliop_migration_bundle.reference_resolver.customreference.class%'
        arguments: []
        tags:
            - { name: kaliop_migration_bundle.context_provider, label: reference_resolver_customreference }

    # NB: This service will see added to the chain any service tagged as 'kaliop_migration_bundle.reference_resolver.customreference'
    kaliop_migration_bundle.reference_resolver.customreference.flexible:
        class: '%kaliop_migration_bundle.reference_resolver.chain_prefix.class%'
        arguments:
            -
                - '@kaliop_migration_bundle.reference_resolver.customreference.base'
                - '@kaliop_migration_bundle.reference_resolver.loop'
                - '@kaliop_migration_bundle.reference_resolver.expression'

    ### misc

    kaliop_migration_bundle.context_handler:
        class: '%kaliop_migration_bundle.context_handler.class%'
        arguments:
            - '@kaliop_migration_bundle.context_storage_handler'
        lazy: true

    # This service is used for the verbose mode when executing migrations on the command line
    kaliop_migration_bundle.step_executed_listener.tracing:
        public: true
        class: '%kaliop_migration_bundle.step_executed_listener.tracing.class%'
        arguments:
            - '%kaliop_migration_bundle.enable_debug_output%'
        tags:
            - { name: kernel.event_listener, event: ibexa_migration.before_execution, method: onBeforeStepExecution }
            - { name: kernel.event_listener, event: ibexa_migration.step_executed, method: onStepExecuted }
            - { name: kernel.event_listener, event: ibexa_migration.migration_aborted, method: onMigrationAborted }
            - { name: kernel.event_listener, event: ibexa_migration.migration_suspended, method: onMigrationSuspended }

    kaliop_migration_bundle.helper.limitation_converter:
        class: '%kaliop_migration_bundle.helper.limitation_converter.class%'
        arguments:
            - '%ibexa.site_access.list%'
            - '@kaliop_migration_bundle.location_matcher'
            - '@kaliop_migration_bundle.section_matcher'
            - '@kaliop_migration_bundle.content_type_matcher'

    kaliop_migration_bundle.helper.sort_converter:
        class: '%kaliop_migration_bundle.helper.sort_converter.class%'

    kaliop_migration_bundle.helper.console_io:
        class: '%kaliop_migration_bundle.helper.console_io.class%'
        public: true
        tags:
            - { name: kernel.event_listener, event: console.command }

    kaliop_migration_bundle.helper.config.resolver:
        class: '%kaliop_migration_bundle.helper.config.resolver%'
        arguments:
            - '@ibexa.config.resolver'
            - '@service_container'

    Kaliop\IbexaMigrationBundle\Command\:
        resource: '../../Command'
        autowire: true
        autoconfigure: true

    ### Aliases

    Kaliop\IbexaMigrationBundle\API\ConfigResolverInterface: '@kaliop_migration_bundle.helper.config.resolver'
    Kaliop\IbexaMigrationBundle\Core\MigrationService: '@kaliop_migration_bundle.migration_service'
    Kaliop\IbexaMigrationBundle\Core\EventListener\TracingStepExecutedListener: '@kaliop_migration_bundle.step_executed_listener.tracing'
    Kaliop\IbexaMigrationBundle\Core\Loader\FilesystemRecursive: '@kaliop_migration_bundle.loader.filesystem_recursive'
    Kaliop\IbexaMigrationBundle\API\ReferenceBagInterface: '@kaliop_migration_bundle.reference_resolver.customreference'
    Kaliop\IbexaMigrationBundle\API\ReferenceResolverBagInterface: '@kaliop_migration_bundle.reference_resolver.customreference'
